# User simulator for chatbot testing

## Description
The evolution of technology increased the complexity of chatbots and also it's testing methods. With the introduction of LLMs, chatbots are capable of humanizing
conversations and imitating the pragmatics of natural language. Several approaches have been created in order to evaluate the
performance of chatbots. 

The code in this project allows creating test cases based in conversations that a user simulator will have
with the chatbot to test.

## Usage

In order to run the simulator, a specific chatbot should be deployed previously (i.e Taskyto, Rasa...). 

The script "autorun.py" contains the functions to load the user simulator profile, start a conversation with the chatbot 
and save this conversation and its configuration par√°meters. The user simulator profile is stored in yaml files,
which should be located in some folder (`user_sim/yaml/user_sim_bikesqa.yaml`).

## Environment Configuration

API keys can be set as environment variables.

The most important API key is `OPENAI_API_KEY`.

## User Profile YAML Configuration

This file contains all the properties the user will follow in order to carry out the conversation. Sice the user simulator is
based in OpenAI GPT4-o LLM technology, some of the fields should be written as prompts in natural language. For this fileds, a 
prompt engineering task should be carried out by the tester to narrow down the role of the user simulator and guide its
behaviour. A description of the fields and an example of the YAML structure is described below.

```
# (float) controls the randomness and diversity of the responses generated by the LLM.
temperature: 0.8                      

# (bool) defines wether the user simulator or the chatbot will start the conversation.
is_starter: True                       

# (str) the chatbot's own fallback message
fallback:
  I'm sorry it's a little loud in my pizza shop, can you say that again?

# (str) the main role the user will perform
role:                                 
  you have to act as a user ordering a pizza to a pizza shop

# (list of str) features addeed to the prompt in order to narrow down the user's role
context:
  - personality:  personalities/formal-user.yml                             
  - you're vegan
  - your name is John

# (list of types) defines what should be said by the user simulator to test tome specific capabilities of the chatbot.
ask_about:
  - "a pizza with the following size: {{size}}"
  - "the following drink: {{drink}}"
  - "the following toppings: {{toppings}}"
  - how long is going to take the pizza to arrive

  - size:
      function: forward(drink)
      type: string
      data:
        - small
        - medium
        - big

  - toppings:
      function: random(rand)
      type: string
      data:
        - cheese
        - mushrooms
        - pepper
        - ham
        - bacon
        - pepperoni
        - olives
        - corn
        - chicken

  - drink:
      function: forward()
      type: string
      data:
        - sprite
        - coke
        - Orange Fanta


# Outputs some specific data defined by the tester.
output:
  - price:
      type: money
      description: The price of the pizza order
  - time:
      type: time
      description: how long is going to take to deliver the pizza

# (list of dict) In this field some parameters should be defined to indicate how the conversations will be carried out.
conversations:
  - number: 1
  - goal_style:
        steps: 5
  - interaction_style:
      - change language:
          - italian
          - portuguese
          - chinese

# (str) Main language of the conversation
language: Engish

# (str) Name of the test suit
test_name: "pizza_order_test"

```

## temperature

  This parameter controls the randomness and diversity of the responses generated by the LLM. The value supported is float between 0.0 and 1.0.

## isstarter

  This parameter defines whether the user will start the conversation or not. The value supported is boolean and will be set depending on the chatbot to test.

## fallback

  Here, the tester should provide the chatbot's original fallback message in order to allow the user simulator to detect fallbacks. This is needed to avoid fallback loops, allowing the user simulator to rephrase the query or change the topic.

## role

  In this field, the tester should define the role the user will deploy during the conversation as a prompt, according to the chatbot to test. 

## context

  This field consist of a list of prompts that will define some characteristics of the user simulator. 
  This can be used to define the name of the user, the availability for an appointment, allergies or intolerances, etc.
  An option for loading predefined "personalities" can be enabled by typing inside of this field "personality:" and the
  path to the YAML file containing the desired personality. These personalities can go along with characteristics added
  by the programmer.
  

## ask_about

This field is used to narrow down the conversation topics the user simulator will carry out with the chatbot. 
It consists of a list of strings and dictionaries.

The tester define a list of prompts with indications for the user simulator to check on the chatbot. 
These prompts can contain variables that should be called inside the text between double brackets {{var}}. 
Variables are useful to provide variability in the testing process and should be instantiated in the list as 
shown in the example above with the exact same name as written between brackets (case-sensitive).

Variables follow a specific structure defined by 3 fields as shown below: data, type and function.
```
ask_about:
  - "cost estimation for photos of {{number_photo}} artworks"
  - number_photo:
      function: forward()
      type: int
      data:
        step: 2
        min: 1
        max: 6

#      data:             (only with float)
#        steps: 0.2 // linspace: 5 
#        min: 1
#        max: 6
```
  ### type
  This field indicates the type of data that will be substituted in the variable placement. 
  The types available for this version are int, float and string, and must be stated as written here.

  ### data
  Here, the data list to use will be defined. In general, the data list must be defined manually by the user, but there 
  are some cases where it can be created automatically, as long as it consists of integers or floats. 

  As shown in the example above, instead of defining a list of the amount of artworks, 
  it is possible to automatically create an integer or float list based on range instructions using a 'min, max, step' structure, 
  where min refers to the minimum value of the list, max refers to the maximum value of the list, 
  and step refers to the separation steps between samples. When working with float data, it can also be used the "linspace" 
  parameter instead of step, where samples will be listed with a linear separation step between them.

  ### function
  Functions are useful to determine how data will be added to the prompt.

  Since the data is listed, functions can be used to iterate through these lists in order to change the information
  inside the variable in each conversation. The functions available in this update are the following:

- default(): the default() function assigns all data in the list to the variable in the prompt.
- random(): this function picks only one random sample inside the list assigned to the variable.
- random(5): this function picks a certain amount of random samples inside the list. In this example, 5 random 
samples will be picked from the list. This number can't exceed the list length.
- random(rand): this function picks a random amount of random samples inside the list. 
This amount will not exceed the list length.
- another(): the another() function will always randomly pick a different sample until finishing the options.
- forward(): this function iterates through each of the samples in the list one by one. It allows to nest multiple
functions of the same type in order to cover all combinations possible. An example of this is shown in the ask_about section
in the main example. To nest forward() functions it is necessary to reference the variable that is going to nest by typing
its name inside the brackets, as shown in the mentioned example:
```
  - "a pizza with the following size: {{size}}"
  - "the following drink: {{drink}}"
  - "the following toppings: {{toppings}}"
  - how long is going to take the pizza to arrive

  - size:
      function: forward(drink)
      type: string
      data:
        - small
        - medium
        - big

  - toppings:
      function: random(rand)
      type: string
      data:
        - cheese
        - mushrooms
        - pepper
        - ham
        - bacon
        - pepperoni
        - olives
        - corn
        - chicken

  - drink:
      function: forward()
      type: string
      data:
        - sprite
        - coke
        - Orange Fanta

```

## output

This field helps the tester get some certain information for the conversation once it is finished. It is used for data validation tasks.

The tester defines some certain values to obtain from the conversation to validate the consistency of the chatbot. The values to obtain should be defined in a list of dictionaries with the name of the value, and should have the following structure:

- type: here it is defined the type of value to output. This type can be one of the following:
  - int: Ouputs the data as an integer.
  - float: Outputs the data as a float.
  - money: Outputs the data as a monetary value with the currency used during the conversation.
  - str: Outputs the data as text.
  - time: Outputs the data in a time format.
  - date: Outputs the data in a date format.
- description: In this parameter, the tester should prompt a text defining which information has to be obtained from the conversation.


## conversations

  This field defines some parameters that will dictate how the conversations will be generated. It consists of 3 parameters: number, goal_style and interaction_style.

- number: this parameter indicates the number of conversations to generate.
- goal_style: this defines how the conversation should end. There are 3 options in this update
  - steps: the tester should input the number of interactions to be done before the conversation ends.
  - random steps: a random number of interactions will be done between 1 and an amount defined by the user. This amount can't exceed 20.
  - all answered: the conversation will end as long as all the queries in "ask_about" have been asked by the user and answered by the chatbot. 
This option is still in beta, and it can be flaky in some cases where the user has to provide data instead of asking for information to the chatbot.
  - default: the default mode enables "all answered" mode, since no steps are defined.
- interaction_style: this indicates how the user simulator should carry out the conversation. There are 7 options in this update
  - long phrase: the user will use very long phrases to write any query.
  - change your mind: the user will change its mind eventually. Useful in conversations when the user has to
                      provide information, such as toppings on a pizza, an appointment date...
  - change language: the user will change the language in the middle of a conversation. This should be defined as a list
                     of languages inside the parameter, as shown in the example above.
  - make spelling mistakes: the user will make typos and spelling mistakes during the conversation
  - single question: the user makes only one query per interaction from "ask_about" field.
  - all questions: the user asks everything inside the "ask_about" field in one interaction.
  - random: this options allows to create a list inside of it with any of the interaction styles mentioned above. 
Then, it selects a random amount of interaction styles to apply to the conversation. Here's an example on how to apply this interaction style:
    ```
    interaction_style:
      - random:
        - make spelling mistakes
        - all questions
        - long phrases
        - change language:
            - italian
            - portuguese
            - chinese
    ```
  - default: the user simulator will carry out the conversation in a natural way.

## language

This parameter defines the main language that will be used in the conversations. If no language is provided, it is set to English by default.

## test_name

Here it is defined the name of the test suit. This name will be assigned to the exported test file and the folder containing the tests.
